# Running R on Google Cloud Platform

**Author**: [Spark Tseung](https://sparktseung.com)

**Last Modified**: Sept 18, 2020

Introduction
------------

Recently, I have been learning how to use the Google Cloud Platform ([GCP](https://cloud.google.com/)) for moderate-scale computing problems. It took me about an hour to set up (not for the first time) an R environment on GCP for running some code for a research paper. Yes, I know we have access to computing resources offered by the university, but sometimes everyone is using it, or sometimes I just need to use more than allocated to each individual students.

Anyways, I will jot down some notes on the steps to get an environment ready for running R on GCP. Naturally, Google is a good friend for a tech rookie such as myself. In addition, without the help of [LeXtudio](https://www.lextudio.com), it would probably have taken much longer for me to figure out everything alone.

In this note, I will briefly go through the following key steps:

* Creating a virtual machine (VM);
* Connecting to the VM via Secured Shell (SSH) using [Bitvise](https://www.bitvise.com/);
* Installing R on the VM; and
* Running an R script on the background.

Creating a Virtual Machine
---------------

I will skip the initial steps of setting up a Google Cloud account. You can get a free $300 credit valid for one year. While using some cloud resources requires credit card information, the card will not be charged until the free credit is exhausted.

Afterwards, the official documentation [here](https://cloud.google.com/compute/docs/quickstart-linux) introduces how to set up a Linux virtual machine on Google Cloud.

(*Side note: The very first time I used Google Cloud back in 2018, I actually set up virtual machines with a full Windows system. The cost turns out to be just too high - if the virtual machine is for computing purposes only, then graphical user interface (GUI) is not necessary. A Linux system with command lines suffices and is much more cost-efficient.*)

For my case, I chose a virtual machine with CPU type `e2-standard-16`. The machine is located in the zone `us-central1-f`, with 16 vCPUs and 64 GB memory, which is good enough for general purposes. As my goal is to do some parallel computing, I chose 16 CPUs, which costs around $0.669 per hour - this is not high, considering I can just run the machine for 10 hours or so and shut it down afterwards. 

Some details to notice:
* I used a Ubuntu system with release 20.xx. I am not sure about the differences between Ubuntu/Debian/CentOS. According to a quick chat with Lex, they only differ in terms of user interface. Hence, any one of them is fine if I just want to compute something on the cloud.
* Allow full access to cloud APIs when setting up the machine (well, just in case I use cloud APIs provided by Google).
* Also allow HTTP/HTTPS traffic. After attempting and failing to understand the fundamentals of computer network, I take these options as default.

Connecting to the VM via Secured Shell (SSH) using Bitvise
---------------

Now that the virtual machine is created on the cloud, the next step is to establish a connection via which to tell the machine to do stuff - this is accomplished by typing **command lines** in a secured shell (SSH). In addition, I will also need to **transfer files** (e.g. R scripts) between my local machine and the cloud - this will be done via SFTP, i.e. SSH File Transfer Protocol.

Previously, I used [PuTTY](https://putty.org/) for command lines and [FileZilla](https://filezilla-project.org/) for file transfer. It turns out that [Bitvise](https://www.bitvise.com/) can do both tasks, so I will use this as an example.

In order to establish a **secured** connection between my local machine and the cloud, there should be some password-protected login procedure.

For my university's server, I need to do the following (quite easy and straightforward):
* Ask for a server address to connect to.
* Once I make a request of connection, the system will prompt me to input login information, which is given by the system administrator.

For the cloud machine I set up by myself, the procedure of connection is somewhat reversed:
* I first generate a Client Key file on my local machine. This is done in Bitvise: Click "Client key manager" -> "Generate new".
* This will generate a **public key**, which is to be associated to the cloud machine: Click "Compute Engine" -> "Metadata" -> "SSH Keys"; Add the generated key to the machine, with a customized username.
* On my local Bitvise, I will input the following login information.
    * Server: "Host" is the External IP of my virtual machine (available on the Google Cloud console). "Port" is 22.
    * Username: Chosen when generating the public key.
    * Initial method: publickey.
    * Client key: The client key just generated by Bitvise.
* Click "Log In". This should open up both a SSH for typing a command line, as well as as SFTP window for file transfer (just the good old drag-and-drop). Neat!

(*Side note: The mechanism behind the scene is roughly as follows (as explained by Lex to a computer network layman like me). When my local machine requests a connection to the cloud machine, the cloud machine sends back the public key. Since the public key is locally generated by my local machine, only my machine can decipher the key. If the key can be decoded, then a connection is established.*)